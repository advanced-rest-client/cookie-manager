<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>cookie-manager test</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>
  <script src="stub.js"></script>
  <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
  <link rel="import" href="../cookie-manager.html">
</head>
<body>
  <test-fixture id="Basic">
    <template>
      <cookie-manager></cookie-manager>
    </template>
  </test-fixture>

  <script>
  /* global CookieStub, DataGenerator */
  suite('cookie-manager', () => {
    function setupWhenLoaded(element, done) {
      element.addEventListener('loading-changed', function f(e) {
        if (e.detail.value) {
          return;
        }
        element.removeEventListener('loading-changed', f);
        flush(() => done());
      });
    }
    suite('Basics', () => {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      test('Queries for cookies when attached', function(done) {
        window.addEventListener('session-cookie-list-all', function f() {
          window.removeEventListener('session-cookie-list-all', f);
          done();
        });
        fixture('Basic');
      });

      test('hasItems is computed', function(done) {
        const element = fixture('Basic');
        window.addEventListener('session-cookie-list-all', function f() {
          window.removeEventListener('session-cookie-list-all', f);
          assert.isFalse(element.hasItems);
          done();
        });
      });

      test('Computes dataUnavailable property', function(done) {
        const element = fixture('Basic');
        window.addEventListener('session-cookie-list-all', function f() {
          window.removeEventListener('session-cookie-list-all', f);
          setTimeout(() => {
            assert.isTrue(element.dataUnavailable);
            done();
          });
        });
      });

      test('Renders add cookie button', function(done) {
        const element = fixture('Basic');
        window.addEventListener('session-cookie-list-all', function f() {
          window.removeEventListener('session-cookie-list-all', f);
          setTimeout(() => {
            const button = element.shadowRoot.querySelector('[data-action="empty-add-cookie"]');
            assert.ok(button);
            done();
          });
        });
      });

      test('Add cookie button opens the editor', function(done) {
        const element = fixture('Basic');
        window.addEventListener('session-cookie-list-all', function f() {
          window.removeEventListener('session-cookie-list-all', f);
          setTimeout(() => {
            const button = element.shadowRoot.querySelector('[data-action="empty-add-cookie"]');
            MockInteractions.tap(button);
            assert.isTrue(element.$.editorContainer.opened);
            done();
          });
        });
      });
    });

    suite('_computeListHidden()', function() {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      setup(function() {
        element = fixture('Basic');
      });
      test('Computes false if searching', function() {
        const result = element._computeListHidden(true, true);
        assert.isFalse(result);
      });
      test('Computes false if searching and no items', function() {
        const result = element._computeListHidden(false, true);
        assert.isFalse(result);
      });
      test('Computes false if when has items', function() {
        const result = element._computeListHidden(true, false);
        assert.isFalse(result);
      });
      test('Computes true when not searching and no items', function() {
        const result = element._computeListHidden(false, false);
        assert.isTrue(result);
      });
    });

    suite('_computeSearchListEmpty()', function() {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      setup(function() {
        element = fixture('Basic');
      });

      test('True when searching, not loading, no data ', function() {
        const result = element._computeSearchListEmpty(false, false, true);
        assert.isTrue(result);
      });

      test('False for any other combination ', function() {
        let result = element._computeSearchListEmpty(true, false, true);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(true, true, true);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(true, true, false);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(false, true, true);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(false, false, false);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(false, true, false);
        assert.isFalse(result);
      });
    });

    suite('_computeDataUnavailable()', function() {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      setup(function() {
        element = fixture('Basic');
      });

      test('True when not searching, not loading, no data ', function() {
        const result = element._computeDataUnavailable(false, false, false);
        assert.isTrue(result);
      });
      test('False for any other combination ', function() {
        let result = element._computeDataUnavailable(true, true, true);
        assert.isFalse(result);
        result = element._computeDataUnavailable(true, true, false);
        assert.isFalse(result);
        result = element._computeDataUnavailable(true, false, true);
        assert.isFalse(result);
        result = element._computeDataUnavailable(false, true, true);
        assert.isFalse(result);
        result = element._computeDataUnavailable(false, false, true);
        assert.isFalse(result);
        result = element._computeDataUnavailable(false, true, false);
        assert.isFalse(result);
        result = element._computeDataUnavailable(false, true, true);
        assert.isFalse(result);
      });
    });

    suite('_processCookies()', function() {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      setup(function(done) {
        element = fixture('Basic');
        setupWhenLoaded(element, done);
      });

      test('Sets empty array if no argument', () => {
        element._processCookies();
        assert.typeOf(element.items, 'array');
        assert.lengthOf(element.items, 0);
      });

      test('Sets Cookies from the argument', () => {
        const cookies = DataGenerator.generateCookiesData({
          size: 10
        });
        element._processCookies(cookies);
        assert.typeOf(element.items, 'array');
        assert.lengthOf(element.items, 10);
      });
    });

    suite('_computeHasItems()', function() {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        setupWhenLoaded(element, done);
      });

      test('Returns false when undefined', () => {
        const result = element._computeHasItems();
        assert.isFalse(result);
      });

      test('Returns false when 0', () => {
        const result = element._computeHasItems(0);
        assert.isFalse(result);
      });

      test('Returns true when positive number', () => {
        const result = element._computeHasItems(5);
        assert.isTrue(result);
      });
    });

    suite('_resetSearch()', function() {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        setupWhenLoaded(element, done);
      });

      test('Sets "items" to "_beforeQueryItems"', () => {
        element._beforeQueryItems = DataGenerator.generateCookiesData({
          size: 50
        });
        element._resetSearch();
        assert.lengthOf(element.items, 50);
      });

      test('Clears "_beforeQueryItems"', () => {
        element._beforeQueryItems = DataGenerator.generateCookiesData({
          size: 50
        });
        element._resetSearch();
        assert.isUndefined(element._beforeQueryItems);
      });

      test('Resets isSearch', () => {
        element.isSearch = true;
        element._resetSearch();
        assert.isFalse(element.isSearch);
      });

      test('Queries for cookies when no _beforeQueryItems', () => {
        const spy = sinon.spy();
        element.addEventListener('session-cookie-list-all', spy);
        element._resetSearch();
        assert.isTrue(spy.called);
      });

      test('Do not query for cookies if _beforeQueryItems', () => {
        element._beforeQueryItems = DataGenerator.generateCookiesData({
          size: 50
        });
        const spy = sinon.spy();
        element.addEventListener('session-cookie-list-all', spy);
        element._resetSearch();
        assert.isFalse(spy.called);
      });
    });

    suite('_delete()', function() {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      let cookies;
      setup((done) => {
        element = fixture('Basic');
        cookies = DataGenerator.generateCookiesData({
          size: 1
        });
        setupWhenLoaded(element, done);
      });

      test('Opens no model toast if event not handled', () => {
        element._delete(cookies);
        assert.isTrue(element.$.noModel.opened);
      });

      test('Dispatches session-cookie-remove', (done) => {
        element.addEventListener('session-cookie-remove', (e) => {
          e.preventDefault();
          assert.deepEqual(e.detail.cookies, cookies, 'Cookie is set');
          assert.isTrue(e.cancelable, 'Event is cancelable');
          assert.isTrue(e.bubbles, 'Event bubbles');
          e.detail.result = Promise.resolve();
          done();
        });
        element._delete(cookies);
      });

      test('Returns a promise from the event', () => {
        element.addEventListener('session-cookie-remove', (e) => {
          e.preventDefault();
          e.detail.result = Promise.resolve();
        });
        const result = element._delete(cookies);
        assert.typeOf(result.then, 'function');
        return result.then;
      });

      test('Opens error toast when promise results to error', (done) => {
        element.addEventListener('session-cookie-remove', (e) => {
          e.preventDefault();
          e.detail.result = Promise.reject(new Error('test'));
        });
        element._delete(cookies)
        .catch(() => {
          assert.isTrue(element.$.errorToast.opened);
          done();
        });
      });

      test('_onDelete() calls _delete() with an argument', () => {
        element.addEventListener('session-cookie-remove', (e) => {
          e.preventDefault();
          e.detail.result = Promise.resolve();
        });
        const items = [{name: test}];
        const spy = sinon.spy(element, '_delete');
        element._onDelete({
          detail: {
            items
          }
        });
        assert.isTrue(spy.called);
        assert.deepEqual(spy.args[0][0], items);
      });
    });

    suite('Export options', function() {
      suiteSetup(function() {
        CookieStub.mockBridge();
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        element.items = DataGenerator.generateCookiesData({
          size: 10
        });
        flush(() => done());
      });

      test('_onExport() calls _exportItems with data', () => {
        const dest = 'file';
        element._exportItems = function(items, destination) {
          assert.deepEqual(items, element.items);
          assert.equal(destination, dest);
        };
        element._onExport({
          detail: {
            items: element.items,
            destination: dest
          }
        });
      });

      test('_exportAllFile() calls _exportItems with data', () => {
        const dest = 'file';
        element._exportItems = function(items, destination) {
          assert.deepEqual(items, element.items);
          assert.equal(destination, dest);
        };
        element._exportAllFile();
      });

      test('_exportAllDrive() calls _exportItems with data', () => {
        const dest = 'drive';
        element._exportItems = function(items, destination) {
          assert.deepEqual(items, element.items);
          assert.equal(destination, dest);
        };
        element._exportAllDrive();
      });

      test('Dispatches export-data event', (done) => {
        window.addEventListener('export-data', function f(e) {
          window.removeEventListener('export-data', f);
          assert.isTrue(e.cancelable, 'Event is cancelable');
          assert.isTrue(e.bubbles, 'Event bubbles');
          assert.typeOf(e.detail.file, 'string');
          assert.equal(e.detail.destination, 'drive');
          assert.equal(e.detail.type, 'arc-export');
          assert.typeOf(e.detail.data, 'object');
          assert.deepEqual(e.detail.data.cookies, element.items);
          done();
        });
        element._exportItems(element.items, 'drive');
      });

      test('Default destination is file', (done) => {
        window.addEventListener('export-data', function f(e) {
          window.removeEventListener('export-data', f);
          assert.equal(e.detail.destination, 'file');
          done();
        });
        element._exportItems(element.items);
      });

      test('Opens toast when event not handled', () => {
        element._exportItems(element.items);
        assert.isTrue(element.$.noExport.opened);
      });
    });

    suite('With cookies', function() {
      let cookies;
      suiteSetup(function() {
        cookies = DataGenerator.generateCookiesData({
          size: 50
        });
        CookieStub.mockBridge(cookies);
      });

      suiteTeardown(function() {
        CookieStub.unmockBridge();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        element.addEventListener('has-items-changed', function f(e) {
          if (!e.detail.value) {
            return;
          }
          element.removeEventListener('has-items-changed', f);
          flush(() => done());
        });
      });

      test('hasItems is computed', function() {
        assert.isTrue(element.hasItems);
      });

      test('Computes dataUnavailable property', function() {
        assert.isFalse(element.dataUnavailable);
      });

      test('Computes listHidden property', function() {
        assert.isFalse(element.listHidden);
      });
    });
  });

  suite('_onSearch()', () => {
    let cookies;
    suiteSetup(function() {
      cookies = DataGenerator.generateCookiesData({
        size: 1
      });
      CookieStub.mockBridge(cookies);
    });

    suiteTeardown(function() {
      CookieStub.unmockBridge();
    });

    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Calls query() with an argument', () => {
      const spy = sinon.spy(element, 'query');
      element._onSearch({
        detail: {
          q: 'test'
        }
      });
      assert.isTrue(spy.called);
      assert.equal(spy.args[0][0], 'test');
    });
  });

  suite('query()', function() {
    let cookies;
    suiteSetup(function() {
      cookies = DataGenerator.generateCookiesData({
        size: 10
      });
      CookieStub.mockBridge(cookies);
    });

    suiteTeardown(function() {
      CookieStub.unmockBridge();
    });

    let element;
    setup((done) => {
      element = fixture('Basic');
      element.addEventListener('has-items-changed', function f(e) {
        if (!e.detail.value) {
          return;
        }
        element.removeEventListener('has-items-changed', f);
        flush(() => done());
      });
    });

    test('Calls _resetSearch() when no argument', () => {
      const spy = sinon.spy(element, '_resetSearch');
      element.query();
      assert.isTrue(spy.called);
    });

    test('Sets isSearch property', () => {
      element.query('test');
      assert.isTrue(element.isSearch);
    });

    test('Sets _beforeQueryItems property', () => {
      element.query('test');
      assert.lengthOf(element._beforeQueryItems, 10);
    });

    test('Won\'t set _beforeQueryItems property when already set', () => {
      const items = [{name: 'test'}];
      element._beforeQueryItems = items;
      element.query('test');
      assert.isTrue(element._beforeQueryItems === items);
    });

    test('Filters by name', () => {
      const name = 'test-name';
      element.items[0].name = name;
      element.query(name);
      assert.lengthOf(element.items, 1);
      assert.equal(element.items[0].name, name);
    });

    test('Filters by name case insensitive', () => {
      const name = 'Test-Name';
      element.items[0].name = name;
      element.query('tesT-namE');
      assert.lengthOf(element.items, 1);
      assert.equal(element.items[0].name, name);
    });

    test('Filters by domain', () => {
      const domain = 'test-domain';
      element.items[0].domain = domain;
      element.query(domain);
      assert.lengthOf(element.items, 1);
      assert.equal(element.items[0].domain, domain);
    });

    test('Filters by domain case insensitive', () => {
      const domain = 'Test-Domain';
      element.items[0].domain = domain;
      element.query('tesT-domaiN');
      assert.lengthOf(element.items, 1);
      assert.equal(element.items[0].domain, domain);
    });

    test('Filters by value', () => {
      const value = 'test-value';
      element.items[0].value = value;
      element.query(value);
      assert.lengthOf(element.items, 1);
      assert.equal(element.items[0].value, value);
    });

    test('Filters by value case insensitive', () => {
      const value = 'Test-Value';
      element.items[0].value = value;
      element.query('tesT-valuE');
      assert.lengthOf(element.items, 1);
      assert.equal(element.items[0].value, value);
    });

    test('Filters by path', () => {
      const path = 'test-path';
      element.items[0].path = path;
      element.query(path);
      assert.lengthOf(element.items, 1);
      assert.equal(element.items[0].path, path);
    });

    test('Filters by path case insensitive', () => {
      const path = 'Test-Path';
      element.items[0].path = path;
      element.query('tesT-patH');
      assert.lengthOf(element.items, 1);
      assert.equal(element.items[0].path, path);
    });

    test('Resets the items when no argument', () => {
      element.query('test-non-existing');
      assert.lengthOf(element.items, 0);
      element.query('');
      assert.lengthOf(element.items, 10);
    });
  });

  suite('_deleteAllClick()', () => {
    suiteSetup(function() {
      CookieStub.mockBridge();
    });

    suiteTeardown(function() {
      CookieStub.unmockBridge();
    });

    let element;
    setup((done) => {
      element = fixture('Basic');
      flush(() => done());
    });

    test('Calls _clearMenuOptions()', () => {
      const spy = sinon.spy(element, '_clearMenuOptions');
      element._deleteAllClick();
      assert.isTrue(spy.called);
    });

    test('Opens working dialog', () => {
      element._deleteAllClick();
      assert.isTrue(element.$.dataClearDialog.opened);
    });
  });

  suite('_onClearDialogResult()', () => {
    suiteSetup(function() {
      CookieStub.mockBridge();
    });

    suiteTeardown(function() {
      CookieStub.unmockBridge();
    });

    let element;
    setup((done) => {
      element = fixture('Basic');
      flush(() => done());
    });

    test('Ignores not confirmed dialog', () => {
      const spy = sinon.spy(element, '_delete');
      element._onClearDialogResult({
        detail: {
          confirmed: false
        }
      });
      assert.isFalse(spy.called);
    });

    test('Ignores action when no items', () => {
      const spy = sinon.spy(element, '_delete');
      element.items = undefined;
      element._onClearDialogResult({
        detail: {
          confirmed: true
        }
      });
      assert.isFalse(spy.called);
    });

    test('Ignores action when items is empty', () => {
      const spy = sinon.spy(element, '_delete');
      element.items = [];
      element._onClearDialogResult({
        detail: {
          confirmed: true
        }
      });
      assert.isFalse(spy.called);
    });

    test('Calls _delete with an argument', () => {
      const spy = sinon.spy(element, '_delete');
      element.items = [{name: 'test'}];
      element._onClearDialogResult({
        detail: {
          confirmed: true
        }
      });
      assert.isTrue(spy.called);
      assert.deepEqual(spy.args[0][0], element.items);
    });
  });

  suite('_compareCookies()', () => {
    suiteSetup(function() {
      CookieStub.mockBridge();
    });

    suiteTeardown(function() {
      CookieStub.unmockBridge();
    });

    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Returns false when domain do not match', () => {
      const a = {domain: 'a'};
      const b = {domain: 'b'};
      const result = element._compareCookies(a, b);
      assert.isFalse(result);
    });

    test('Returns false when path do not match', () => {
      const a = {domain: 'a', path: 'a'};
      const b = {domain: 'a', path: 'b'};
      const result = element._compareCookies(a, b);
      assert.isFalse(result);
    });

    test('Returns false when name do not match', () => {
      const a = {domain: 'a', path: 'a', name: 'a'};
      const b = {domain: 'a', path: 'a', name: 'b'};
      const result = element._compareCookies(a, b);
      assert.isFalse(result);
    });

    test('Returns true otherwise', () => {
      const a = {domain: 'a', path: 'a', name: 'a'};
      const b = {domain: 'a', path: 'a', name: 'a'};
      const result = element._compareCookies(a, b);
      assert.isTrue(result);
    });
  });

  suite('_getCookieIndex()', () => {
    suiteSetup(function() {
      CookieStub.mockBridge();
    });

    suiteTeardown(function() {
      CookieStub.unmockBridge();
    });

    let element;
    setup(() => {
      element = fixture('Basic');
      element.items = DataGenerator.generateCookiesData({
        size: 3
      });
    });

    test('Returns cookie index', () => {
      const result = element._getCookieIndex(element.items[1]);
      assert.equal(result, 1);
    });

    test('Returns -1 when not found', () => {
      const result = element._getCookieIndex({name: 'a', path: 'b', domain: 'c'});
      assert.equal(result, -1);
    });

    test('Returns -1 when no items', () => {
      element.items = undefined;
      const result = element._getCookieIndex({name: 'a', path: 'b', domain: 'c'});
      assert.equal(result, -1);
    });

    test('Returns -1 when items is empty', () => {
      element.items = [];
      const result = element._getCookieIndex({name: 'a', path: 'b', domain: 'c'});
      assert.equal(result, -1);
    });
  });

  suite('_onCookieRemoved()', () => {
    suiteSetup(function() {
      CookieStub.mockBridge();
    });

    suiteTeardown(function() {
      CookieStub.unmockBridge();
    });

    let element;
    setup(() => {
      element = fixture('Basic');
      element.items = DataGenerator.generateCookiesData({
        size: 3
      });
    });

    function fire(cookie, cancelable) {
      if (cancelable === undefined) {
        cancelable = false;
      }
      const e = new CustomEvent('session-cookie-removed', {
        bubbles: true,
        cancelable,
        detail: cookie
      });
      document.body.dispatchEvent(e);
    }

    test('Ignores cancelable events', () => {
      fire(element.items[0], true);
      assert.lengthOf(element.items, 3);
    });

    test('Removes a cookie', () => {
      fire(element.items[1]);
      assert.lengthOf(element.items, 2);
    });

    test('Ignores action when cookie not found', () => {
      fire({name: 'a', domain: 'b', path: 'c'});
      assert.lengthOf(element.items, 3);
    });

    test('Resets _nextInsertAtPosition', () => {
      element._nextInsertAtPosition = true;
      fire(element.items[1]);
      assert.isFalse(element._nextInsertAtPosition);
    });

    test('Sets _nextInsertPosition', () => {
      element._nextInsertAtPosition = true;
      fire(element.items[2]);
      assert.equal(element._nextInsertPosition, 2);
    });
  });

  suite('_onCookieChanged()', () => {
    suiteSetup(function() {
      CookieStub.mockBridge();
    });

    suiteTeardown(function() {
      CookieStub.unmockBridge();
    });

    let element;
    setup(() => {
      element = fixture('Basic');
      element.items = DataGenerator.generateCookiesData({
        size: 3
      });
    });

    function fire(cookie) {
      const e = new CustomEvent('session-cookie-changed', {
        bubbles: true,
        detail: cookie
      });
      document.body.dispatchEvent(e);
    }

    test('Updates existing cookie', () => {
      const cookie = Object.assign({}, element.items[0]);
      cookie.value = 'test-value';
      fire(cookie);
      assert.equal(element.items[0].value, 'test-value');
    });

    test('Adds new cookie', () => {
      fire({name: 'a', domain: 'b', path: 'c'});
      assert.lengthOf(element.items, 4);
      assert.equal(element.items[3].name, 'a');
    });

    test('Creates items', () => {
      element.items = undefined;
      fire({name: 'a', domain: 'b', path: 'c'});
      assert.lengthOf(element.items, 1);
    });

    test('Updates cookie at position', () => {
      element._nextInsertPosition = 1;
      const cookie = {name: 'a', domain: 'b', path: 'c'};
      fire(cookie);
      assert.deepEqual(element.items[1], cookie);
    });
  });
  </script>
</body>
</html>
